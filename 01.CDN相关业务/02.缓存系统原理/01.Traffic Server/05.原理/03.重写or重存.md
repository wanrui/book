测试URL为：
测试方法：
实现方法：客户访问URL1的返回给客户端URL2的真实内容:

```
URL1. http://www.baidu.com/newsapp_ls/0/1927120533_294195/0 
URL2. http://inews.gtimg.com/newsapp_ls/0/1927120533_294195/0

curl -v -x 192.168.104.159:51899 -o /dev/null http://www.baidu.com/newsapp_ls/0/1927120533_294195/0

```

配置方式1（失败）：
该配置方式不能够满足重写的要求。是应为 `proxy.config.url_remap.pristine_host_hdr` 开关打开了。该参数的含义为：打开这个开关后，在remaping 的过程中，会保留客户端请求过来的Host 头属性。所以缓存的key 会是保留之前的内容url。很多情况下我们制定一个特定的cachekey，在当前的情况下ats 提供两个接口`TSHttpTxnCacheLookupUrlSet()`和`TSCacheUrlSet()`对缓存key 的设置，`TSHttpTxnCacheLookupUrlGet() `对缓存key的查询，请注意插件挂钩自的时机在事件`TS_HTTP_READ_REQUEST_HDR_HOOK`之后，事件`TS_HTTP_POST_REMAP_HOOK`之前进行API的调用和设置。


```
remap.config
    map http://www.baidu.com/ http://inews.gtimg.com/
records.config
    CONFIG proxy.config.url_remap.pristine_host_hdr INT 1
结果：

> GET http://www.baidu.com/newsapp_ls/0/1927120533_294195/0 HTTP/1.1
> Host:www.baidu.com
> User-Agent: curl/7.43.0
> Accept: */*
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 404 Not Found
< Server: NWS_SSD_MID
< Date: Thu, 17 Aug 2017 08:51:50 GMT
< Last-Modified: Thu, 17 Aug 2017 08:50:00 GMT
< Content-Type: text/html
< Content-Length: 84
< X-NWS-LOG-UUID: f74895d2-4e9a-49af-8edd-3fa2cdf61236 92a562a63ef8f9f95ef26c7d2d510a4f
< X-Daa-Tunnel: hop_count=1
< X-Cache-Lookup: Hit From Upstream
< Age: 1
< Proxy-Connection: keep-alive
< Via: CT-YNKMJKQ-C-151-115 (DLC-3.0)
< HitType: TCP_MISS  

请求源站报文：

GET /templates/metx5/images/img/news_bottom.png HTTP/1.1
Host: www.baidu.com
User-Agent: curl/7.43.0
Accept: */*
Client-ip: 192.168.41.87
X-Forwarded-For: 192.168.41.87

HTTP/1.1 404 Not Found on Accelerator
Server: DnionOS/1.11.2.1.10
Date: Thu, 17 Aug 2017 05:02:27 GMT
Content-Type: text/html
Content-Length: 240
Connection: keep-alive
Via: CT-ZJHZ-C-215-89 (DLC-3.0)
Cache-Control: no-store 
日志记录的url：
http://www.baidu.com/newsapp_ls/0/1927120533_294195/0
    
```



配置方式2：
该配置方法能够满足域名重写的功能，通过http_request_rewrite 插件的功能实现， 且`remap.config`文件只需要配置重写后的域名即可，说明重写的动作是在remap之前做的。具体我们该插件的实现上面钩子在哪里下的：`TS_HTTP_PRE_REMAP_HOOK` 在remap生效前做的。

```
remap.config
    map http://inews.gtimg.com/ http://inews.gtimg.com/

records.config
    CONFIG proxy.config.url_remap.pristine_host_hdr INT 1
    
ats_plugin.config    
    [http_request_rewrite]
^http://www\.baidu\.com/(.*)$ http://inews.gtimg.com/$1

结果为：
> GET http://www.baidu.com/newsapp_ls/0/1927120533_294195/0 HTTP/1.1
> Host:www.baidu.com
> User-Agent: curl/7.43.0
> Accept: */*
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
< Server: NWS_UGC_HY
< Date: Thu, 17 Aug 2017 09:28:07 GMT
< Cache-Control: max-age=2592000
< Expires: Sat, 16 Sep 2017 09:28:07 GMT
< Last-Modified: Thu, 17 Aug 2017 08:34:22 GMT
< Content-Type: image/jpeg
< Content-Length: 11057
日志记录的url：
http://www.baidu.com/newsapp_ls/0/1927120533_294195/0
cacheUrl：
http://inews.gtimg.com/newsapp_ls/0/1927120533_294195/0

```


