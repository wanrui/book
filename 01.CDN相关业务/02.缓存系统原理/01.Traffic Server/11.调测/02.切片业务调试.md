# 切片逻辑相关插件

* cache\_range\_request：针对range 请求的进行cache 操作；
* transform：针对range 请求进行转换 ；
* url\_rewrite：针对请求进行重写重存，关键在于cachekey 的操作；

原理上来讲：  
1. nginx 的切片模块打开，进行切片，能够格式化切片，并进行合并，例如：10Mb的文件，切片大小配置1MB,那么有nginx收到的整个包的请求的时候，反向代理到后端需要将请求进行分解成10个切片的大小，然后进行合并；如果nginx 收到range 请求，那么它必须对range 请求进行格式化，找到对应的切片区域，然后发送对应的切片，然后进行合并，返回给客户端；  
2. traffic server 能够对range 请求能够进行缓存，不同的range 范围内的range请求进行分别存储，特别注意的地方是，不同的range 请求一定要使用不同的key 进行缓存，否则缓存文件会被重写掉。目前标准的key 的重写方式为`URL/-bytes=0-1048575`  
3. 从逻辑上来说transform 插件和cache\_range\_request 插件是冲突的，transform是去掉range 然后从源站请求完整数据包回来，cache\_range\_request是收到range 请求回源请求为range 请求。所以他们之间的需要有一个请求头`Dn-Action: Slice`进行区分,如果traffic server 收到的请求头中包含`Dn-Action: Slice` 将走逻辑会是cache\_range\_request插件  
4. cache key 的重写这部分的逻辑，专门由url\_rewrite 进行管理，所以如果是range 切片的请求 ，内部需要进行标识 ，然后进行重写cache key

目前线上015 运行的情况来看存在一种现象  
1. 情况1：这种缓存方式是对的，cache key 的设置方式是按照`URL/-bytes=0-1048575`来进行修改的，请求头和响应头的处理也是对的；

```
http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4/-bytes=0-1048575

Doc
Volume    #0 - store='/dev/sdd'
first key    555C8DCCB55087CC3E32053ADB2ADD87
key    1216F37942328B9CD47CF4A385D0834B
sync_serial    597
write_serial    30500
header length    2736
fragment type    1
No of Alternates    1
Action    
Delete URL

Alternate 1
Request Header    
GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1
User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
Host: videop-cdl.capitalcloud.net
Accept: */*
DnionType: EDGE
Dn-Action: Slice
Client-ip: 127.0.0.1
X-Forwarded-For: 127.0.0.1

Response Header    
HTTP/1.1 200 Partial Content
Server: openresty/1.11.2.2
Date: Fri, 15 Sep 2017 15:25:49 GMT
Content-Type: video/mp4
Content-Length: 1048576
Connection: keep-alive
Last-Modified: Mon, 22 May 2017 03:51:32 GMT
Age: 4636
Via: CT-CNC-ZJFY-P-16-54 (DLC-3.0)
Content-Range: bytes 0-1048575/20752056

Size    1048576
Key    1216F37942328B9CD47CF4A385D0834B
Request sent time    Fri Sep 15 23:25:49 2017
Response received time    Fri Sep 15 23:25:49 2017
```

情况2：这种方式的处理是错误的，cache key 的设置方式没按照 按照`URL/-bytes=0-1048575`来进行修改的，导致后续的请求是不能正常缓存，和访问的。  
开启debug 调试模式：

```
http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4

Doc
Volume    #0 - store='/dev/sdl'
first key    AB19D5976A23C61DF9B812E24C42F891
key    ACE785C382DC5D81B030AAFF9DDC8CC8
sync_serial    554
write_serial    28599
header length    3192
fragment type    1
No of Alternates    1
Action    
Delete URL

Alternate 1
Request Header    
GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1
DnionType: EDGE
Host: videop-cdl.capitalcloud.net
X-Forwarded-For: 218.76.1.2, 42.81.25.50, 42.81.25.51, 42.81.11.6
Dn-Action: Slice
User-Agent: VLC/2.2.6 LibVLC/2.2.6
Icy-MetaData: 1
Client-ip: 42.81.25.50
If-Modified-Since: Mon, 22 May 2017 03:51:32 GMT
Range: bytes=0-1048575

Response Header    
HTTP/1.1 200 Partial Content
Server: openresty/1.11.2.2
Date: Fri, 15 Sep 2017 03:24:40 GMT
Content-Type: video/mp4
Content-Length: 1048576
Connection: keep-alive
Last-Modified: Mon, 22 May 2017 03:51:32 GMT
Age: 0
Via: CT-CNC-ZJFY-P-16-54 (DLC-3.0)
Content-Range: bytes 0-1048575/20752056

Size    1048576
Key    EF7887A507F8DB68243AF7548CFB8F51
Request sent time    Fri Sep 15 11:24:39 2017
Response received time    Fri Sep 15 11:24:40 2017
```

测试记录如下：

```
访问Range: bytes=3048576-4097151
返回的内容为：Content-Range: bytes 3048576-4097151/20752056
状态为：HitType: TCP_MISS



[root@XNOP015-CT-TJTJ-P-11-6 logs]# curl http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 -v -o 1.mp4  -x 127.0.0.1:51899 -H "DnionType: EDGE"  -r  3048576-4097151  -H "Dn-Action: Slice"
* About to connect() to proxy 127.0.0.1 port 51899 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 51899 (#0)
> GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1
> Range: bytes=3048576-4097151
> User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
> Host: videop-cdl.capitalcloud.net
> Accept: */*
> Proxy-Connection: Keep-Alive
> DnionType: EDGE
> Dn-Action: Slice
> 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0< HTTP/1.1 206 Partial Content
< Server: openresty/1.11.2.2
< Date: Fri, 15 Sep 2017 09:49:48 GMT
< Content-Type: video/mp4
< Content-Length: 1048576
< Last-Modified: Mon, 22 May 2017 03:51:32 GMT
< Age: 0
< Via: CT-CNC-ZJFY-P-16-54 (DLC-3.0), CT-TJTJ-P-11-6 (DLC-3.0)
< Content-Range: bytes 3048576-4097151/20752056
< Proxy-Connection: keep-alive
< HitType: TCP_MISS
< HierType: PARENT
< SourceIP: 183.131.16.52
< RespCode: 206
< 
{ [data not shown]
100 1024k  100 1024k    0     0  3002k      0 --:--:-- --:--:-- --:--:-- 3011k* Connection #0 to host 127.0.0.1 left intact

* Closing connection #0

访问Range: Range: bytes=1048576-2097151
返回的内容为：Content-Range: bytes 3048576-4097151/20752056
状态为：HitType: TCP_HIT

没错，你看到的没错！就是那么尴尬的错了

[root@XNOP015-CT-TJTJ-P-11-6 logs]# curl http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 -v -o 1.mp4  -x 127.0.0.1:51899 -H "DnionType: EDGE"  -r  1048576-2097151  -H "Dn-Action: Slice"
* About to connect() to proxy 127.0.0.1 port 51899 (#0)
*   Trying 127.0.0.1... connected
* Connected to 127.0.0.1 (127.0.0.1) port 51899 (#0)
> GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1
> Range: bytes=1048576-2097151
> User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
> Host: videop-cdl.capitalcloud.net
> Accept: */*
> Proxy-Connection: Keep-Alive
> DnionType: EDGE
> Dn-Action: Slice
> 
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0< HTTP/1.1 206 Partial Content
< Server: openresty/1.11.2.2
< Date: Fri, 15 Sep 2017 09:49:48 GMT
< Content-Type: video/mp4
< Content-Length: 1048576
< Last-Modified: Mon, 22 May 2017 03:51:32 GMT
< Age: 25
< Via: CT-CNC-ZJFY-P-16-54 (DLC-3.0), CT-TJTJ-P-11-6 (DLC-3.0)
< Content-Range: bytes 3048576-4097151/20752056
< Proxy-Connection: keep-alive
< HitType: TCP_HIT
< HierType: NONE
< 
{ [data not shown]
100 1024k  100 1024k    0     0  91.9M      0 --:--:-- --:--:-- --:--:--  100M* Connection #0 to host 127.0.0.1 left intact

* Closing connection #0
```

以下：log 日志有所删减，异常状态下的log 状态

```
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http_trans) START HttpTransact::HandleRequest
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http_trans) [is_request_valid]no request header errors
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http_seq) [HttpTransact::HandleRequest] request valid.
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http) HTTP_HEADER 0x2b77cec96898: [T: 3, L:   48, OBJFLAGS: 0]  
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http)     HOST: "videop-cdl.capitalcloud.net", HOST_LEN: 27,
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http)     PATH: "pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4", PATH_LEN: 96,[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http) [FREETOP: 7, NEXTBLK: (nil)]
-- 重点出现了，range 头已经被删除
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http)     SLOT # 0 (0x2b77cec96918), DELETED 
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http) [N: "Range", N_LEN: 5, N_IDX: 52, 
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http) V: "bytes=2048576-3097151", V_LEN: 21, 
[Sep 15 17:49:09.232] Server {0x2b760d211700} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 30, F: 1]
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http)     SLOT # 2 (0x2b77cec96958), LIVE    
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) [N: "Host", N_LEN: 4, N_IDX: 30, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) V: "videop-cdl.capitalcloud.net", V_LEN: 27, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 35, F: 1]
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http)     SLOT # 5 (0x2b77cec969b8), LIVE    
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) [N: "DnionType", N_LEN: 9, N_IDX: -1, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) V: "EDGE", V_LEN: 4, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 17, F: 1]
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http)     SLOT # 6 (0x2b77cec969d8), LIVE    
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) [N: "Dn-Action", N_LEN: 9, N_IDX: -1, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) V: "Slice", V_LEN: 5, 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 18, F: 1]
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) 
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_trans) [init_stat_vars_from_req] set req cont length to 0
+++++++++ Incoming Request +++++++++
-- State Machine Id: 54624000
GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1
User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2
Host: videop-cdl.capitalcloud.net
Accept: */*
--- 重点出现了，range请求头被删除了，说明cache range 插件的工作已经生效了
Proxy-Connection: Keep-Alive
DnionType: EDGE
Dn-Action: Slice

[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_trans) [DecideCacheLookup] Will do cache lookup.
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_seq) [DecideCacheLookup] Will do cache lookup
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_trans) Next action CACHE_LOOKUP; NULL
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http) [54624000] State Transition: HTTP_API_POST_REMAP -> CACHE_LOOKUP
--- 重点出现了 cache key 并未被修改
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_seq) [HttpSM::do_cache_lookup_and_read] [54624000] Issuing cache lookup for URL http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4
[Sep 15 17:49:09.233] Server {0x2b760d211700} DEBUG: (http_cache) [54624000] [&HttpCacheSM::state_cache_open_read, CACHE_EVENT_OPEN_READ_FAILED]
```

缓存删除，情况依然存在，重启后现象就不存在了，那么重启后的日志会是什么样子的？

```
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http_trans) START HttpTransact::HandleRequest
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http_trans) [is_request_valid]no request header errors
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http_seq) [HttpTransact::HandleRequest] request valid.
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) HTTP_HEADER 0x2b88ceecd098: [T: 3, L:   48, OBJFLAGS: 0]
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) [TYPE: REQ, V: 10001, URL: 0x2b88ceecd318, METHOD: "GET", METHOD_LEN: 3, FIELDS: 0x2b88ceecd0c8]
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) URL 0x2b88ceecd318: [T: 2, L:  112, OBJFLAGS: 0]
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     HOST: "videop-cdl.capitalcloud.net", HOST_LEN: 27,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     PATH: "pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4", PATH_LEN: 96,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     [CBITS: 0x00000000, T_MAXAGE: 0, T_SMAXAGE: 0, T_MAXSTALE: 0, T_MINFRESH: 0, PNO$: 0]
-- 重点出现了，range 头已经被删除

[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     SLOT # 0 (0x2b88ceecd118), DELETED
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) [N: "Range", N_LEN: 5, N_IDX: 52,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) V: "bytes=1048576-2097151", V_LEN: 21,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 30, F: 1]
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     SLOT # 5 (0x2b88ceecd1b8), LIVE
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) [N: "DnionType", N_LEN: 9, N_IDX: -1,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) V: "EDGE", V_LEN: 4,
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 17, F: 1]
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)
[Sep 16 11:46:48.540] Server {0x2b868275e6c0} DEBUG: (http)     SLOT # 6 (0x2b88ceecd1d8), LIVE
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http) [N: "Dn-Action", N_LEN: 9, N_IDX: -1,
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http) V: "Slice", V_LEN: 5,
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http) NEXTDUP: (nil), RAW: 1, RAWLEN: 18, F: 1]
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http)
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_trans) [init_stat_vars_from_req] set req cont length to 0
+++++++++ Incoming Request +++++++++
-- State Machine Id: 46823
GET http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4 HTTP/1.1^M
User-Agent: curl/7.19.7 (x86_64-redhat-linux-gnu) libcurl/7.19.7 NSS/3.21 Basic ECC zlib/1.2.3 libidn/1.18 libssh2/1.4.2^M
Host: videop-cdl.capitalcloud.net^M
Accept: */*^M
--- 重点出现了，range请求头被删除了，说明cache range 插件的工作已经生效了

Proxy-Connection: Keep-Alive^M
DnionType: EDGE^M
Dn-Action: Slice^M
^M
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_trans) [DecideCacheLookup] Will do cache lookup.
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_seq) [DecideCacheLookup] Will do cache lookup
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_trans) Next action CACHE_LOOKUP; NULL
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http) [46823] State Transition: HTTP_API_POST_REMAP -> CACHE_LOOKUP
--- 重点出现了 cache key已经被修改了！！！！！这现象真的奇葩了！！！

[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_seq) [HttpSM::do_cache_lookup_and_read] [46823] Issuing cache lookup for URL http://videop-cdl.capitalcloud.net/pub-386922041666070307/ent-1001368222567733040/ren-1001369141797592580/1/1001369141797592580.mp4/-bytes=1048576-2097151
[Sep 16 11:46:48.541] Server {0x2b868275e6c0} DEBUG: (http_cache) [46823] [&HttpCacheSM::state_cache_open_read, CACHE_EVENT_OPEN_READ_FAILED]
```

怀疑一个问题，重写插件url\_rewrite没有生效呢？ 查看当前进程是否加载改插件文件，发现已经加载了。分析一下 文代码逻辑呢  
那么可疑的地方有几个点：  
1. cache range 与url\_rewrite 的信息共享在哪里呢？通常插件内部信息共享是TSHttpArgIndexReserve、TSHttpTxnArgSet、TSHttpTxnArgGet进行的；  
2. 以上工作是正常的，cache range 插件处理函数是否在删除Range 后，把rang 头信息设置txnp 中；从而影响到对cache key 的设置呢？  
3. 以上工作正常的，那么是否在在cache range 插件处理的range 信息是否能够传递 然后url\_rewrite 插件是否能够在事务中否处理中cache range 设置过来的信息信息？

以上三点考虑，发现只有最后一点没有执行到。~~奇葩了





```
Breakpoint 3, TSHttpTxnArgSet (txnp=0x2baa42c76910, arg_idx=0, arg=0x2baf5dceaad0) at InkAPI.cc:5618
5618    in InkAPI.cc
(gdb) c
Continuing.
[Switching to Thread 0x2ba2ad615700 (LWP 28133)]

Breakpoint 3, TSHttpTxnArgSet (txnp=0x2baa42c76910, arg_idx=0, arg=0x2bafcf3563b0) at InkAPI.cc:5618
5618    in InkAPI.cc
(gdb) p arg_idx
$5 = 0
(gdb) p (char *)arg
$7 = 0x2bafcf3563b0 "/-bytes=1048576-2097151"
-- 重点出现
(gdb)  p state_arg_table
$4 =   {[0] = {
    name = 0x1ee62d0 "cache_range_requests", 
    name_len = 20, 
    description = 0x1ef1ee0 "cache range args"
  },
  [1] = {
    name = 0x2013950 "dir_purge", 
    name_len = 9, 
    description = 0x2013970 "dir_purge"
  },
  [2] = {
    name = 0x0, 
    name_len = 0, 
    description = 0x0
  } <repeats 62 times>}

(gdb) bt
#0  TSHttpTxnArgSet (txnp=0x2baa42c76910, arg_idx=0, arg=0x2bafcf3563b0) at InkAPI.cc:5618
#1  0x00002ba2af0838de in range_header_check (contp=0x2baf75e6fe70, event=Unhandled dwarf expression opcode 0xf3
) at /tmp/plugin/cache_range_requests/cache_range_requests.cc:99
#2  cache_range_requests::transaction_handler (contp=0x2baf75e6fe70, event=Unhandled dwarf expression opcode 0xf3
) at /tmp/plugin/cache_range_requests/cache_range_requests.cc:292
#3  0x000000000053b6b4 in HttpSM::state_api_callout (this=0x2baa42c76910, event=<value optimized out>, data=<value optimized out>) at HttpSM.cc:1444
#4  0x00000000005427ea in HttpSM::set_next_state (this=0x2baa42c76910) at HttpSM.cc:6872
#5  0x0000000000539db3 in HttpSM::state_read_client_request_header (this=0x2baa42c76910, event=100, data=<value optimized out>) at HttpSM.cc:848
#6  0x0000000000540e18 in HttpSM::main_handler (this=0x2baa42c76910, event=100, data=0x2ba2cc1a0130) at HttpSM.cc:2566
#7  0x000000000069c1db in handleEvent (event=<value optimized out>, vc=0x2ba2cc1a0020) at ../../iocore/eventsystem/I_Continuation.h:146
#8  read_signal_and_update (event=<value optimized out>, vc=0x2ba2cc1a0020) at UnixNetVConnection.cc:139
#9  0x00000000006a0674 in read_from_net (nh=0x2ba2a7df3cc0, vc=0x2ba2cc1a0020, thread=<value optimized out>) at UnixNetVConnection.cc:321
#10 0x0000000000697762 in NetHandler::mainNetEvent (this=0x2ba2a7df3cc0, event=<value optimized out>, e=<value optimized out>) at UnixNet.cc:381
#11 0x00000000006bf6af in handleEvent (this=0x2ba2a7df0010, e=0x1c66f70, calling_code=5) at I_Continuation.h:146
#12 EThread::process_event (this=0x2ba2a7df0010, e=0x1c66f70, calling_code=5) at UnixEThread.cc:145
#13 0x00000000006c0093 in EThread::execute (this=0x2ba2a7df0010) at UnixEThread.cc:269
#14 0x00000000006be54a in spawn_thread_internal (a=0x1ad9920) at Thread.cc:88
#15 0x00002ba2a6246a51 in start_thread () from /lib64/libpthread.so.0
#16 0x0000003cadae896d in clone () from /lib64/libc.so.6
(gdb)
```

```
TSReturnCode
TSHttpArgIndexReserve(const char* name, const char* description, int *arg_idx)
{
  sdk_assert(sdk_sanity_check_null_ptr(arg_idx) == TS_SUCCESS);

  int volatile ix = ink_atomic_increment(&next_argv_index, 1);

  if (ix < HTTP_SSN_TXN_MAX_USER_ARG) {
    state_arg_table[ix].name = ats_strdup(name);
    state_arg_table[ix].name_len = strlen(state_arg_table[ix].name);
    if (description)
      state_arg_table[ix].description = ats_strdup(description);
    *arg_idx = ix;

    return TS_SUCCESS;
  }
  return TS_ERROR;
}

TSReturnCode
TSHttpArgIndexLookup(int arg_idx, const char** name, const char** description)
{
  if (sdk_sanity_check_null_ptr(name) == TS_SUCCESS) {
    if (state_arg_table[arg_idx].name) {
      *name = state_arg_table[arg_idx].name;
      if (description)
        *description = state_arg_table[arg_idx].description;
      return TS_SUCCESS;
    }
  }
  return TS_ERROR;
}

// Not particularly efficient, but good enough for now.
TSReturnCode
TSHttpArgIndexNameLookup(const char* name, int *arg_idx, const char **description)
{
  sdk_assert(sdk_sanity_check_null_ptr(arg_idx) == TS_SUCCESS);

  size_t len = strlen(name);

  for (int ix = 0; ix <  next_argv_index; ++ix) {
    if ((len == state_arg_table[ix].name_len) && (0 == strcmp(name, state_arg_table[ix].name))) {
      if (description)
        *description = state_arg_table[ix].description;
      *arg_idx = ix;
      return TS_SUCCESS;
    }
  }
  return TS_ERROR;
}

void
TSHttpTxnArgSet(TSHttpTxn txnp, int arg_idx, void *arg)
{
  sdk_assert(sdk_sanity_check_txn(txnp) == TS_SUCCESS);
  sdk_assert(arg_idx >= 0 && arg_idx < HTTP_SSN_TXN_MAX_USER_ARG);

  HttpSM *sm = (HttpSM *) txnp;
  sm->t_state.user_args[arg_idx] = arg;
}

void *
TSHttpTxnArgGet(TSHttpTxn txnp, int arg_idx)
{
  sdk_assert(sdk_sanity_check_txn(txnp) == TS_SUCCESS);
  sdk_assert(arg_idx >= 0 && arg_idx < HTTP_SSN_TXN_MAX_USER_ARG);

  HttpSM *sm = (HttpSM *) txnp;
  return sm->t_state.user_args[arg_idx];
}
```



